name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'infrastructure/**'
      - '.github/workflows/azure-backend-deploy.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_PACKAGE_PATH: './publish'
  RESOURCE_GROUP: 'rg-mototriporganizer-dev'
  WEBAPP_NAME: 'mototriporg-dev-api'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build and Publish
      run: |
        dotnet restore src/MotoTripOrganizer.Api/MotoTripOrganizer.Api.csproj
        dotnet build src/MotoTripOrganizer.Api/MotoTripOrganizer.Api.csproj --configuration Release --no-restore
        dotnet publish src/MotoTripOrganizer.Api/MotoTripOrganizer.Api.csproj -c Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        echo "‚úÖ Build completed"
        echo "Verifying EF Core DLLs..."
        ls -la ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/*EntityFrameworkCore*

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Install zip utility
      run: sudo apt-get update && sudo apt-get install -y zip
        
    - name: Deploy to Azure Web App
      run: |
        echo "üì¶ Creating deployment package..."
        cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        zip -r ../deploy.zip * .[^.]*
        cd ..
        
        echo "üöÄ Deploying to Azure..."
        az webapp deployment source config-zip \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.WEBAPP_NAME }} \
          --src deploy.zip \
          --timeout 600
        
        echo "‚úÖ Deployment completed"

    - name: Health check
      run: |
        WEBAPP_URL=$(az webapp show --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query defaultHostName -o tsv)
        HEALTH_URL="https://${WEBAPP_URL}/health"
        echo "üè• Checking health at $HEALTH_URL"
        
        # Wait for app to start after deployment
        echo "Waiting 30 seconds for app startup..."
        sleep 30
        
        for i in {1..10}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          if [ $STATUS -eq 200 ]; then
            echo "‚úÖ Health check passed!"
            exit 0
          fi
          echo "Attempt $i/10: Status $STATUS, retrying in 15s..."
          sleep 15
        done
        
        echo "‚ùå Health check failed after 10 attempts"
        exit 1
